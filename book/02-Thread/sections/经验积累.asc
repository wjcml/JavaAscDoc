=== 记一次多线程研发遇到的坑

==== 问题背景
----
1. 开发一套经验支持系统，就是通过创建公共的经验模型和规则，然后由模型获取并整合数据，将数据输入规则中，得到返回结果。
2. 难点：模型中存在多个对象（M），并且每个对象可以通过SQL获取API获取多个数据（N），也就是说，跑一次模型，一个规则需要被执行 M 次，并且需要查询数据 M * N 次。
3. 目标：降低跑一次模型需要用的时间，提升速度。
----
如下图：

image::多线程遇到的坑-业务逻辑图.png[]


==== 研发方案的迭代

----
1. for循环
2. 线程池框架 ThreadPoolExecutor（Disruptor，gitee-京东零售）
----

==== 遇到的坑

===== 死锁
----
出现问题的原因：
1. 只定义了一个线程池
2. 自定义了 10 个核心线程数
3. 有 60 个对象需要执行规则逻辑（下面用 A 代替），每个对象需要 调用 2 个api接口获取数据
4. 如果有 10 个 A 占用了 10 个线程，但是他们需要等待 api 接口获取到数据才能继续执行，但是查数据的任务又在等待队列中，等待核心线程资源释放，这时就会一直等待

解决办法：
1. 创建两个线程池分别执行这两种任务
----

===== 经典线程安全问题
----
出现问题的原因：
1. 多个线程中对同一个对象中的属性进行修改

解决办法：
1. 禁止在多线程中对同一个对象的属性进行修改
2. 使用JUC下的线程安全对象
3. 在子线程中创建新的对象接受需要修改的值，最后通过线程返回值返回
4. 对数据操作方法加锁（不推荐）
----


